{
  "openapi": "3.1.0",
  "info": {
    "title": "Pavement Performance Suite – Supabase Edge Functions",
    "version": "0.3.0",
    "description": "Documented Supabase Edge Function endpoints powering AI proxying, observability, and supplier intelligence for Pavement Performance Suite.",
    "title": "Pavement Performance Suite – Edge Functions API",
    "version": "0.3.0",
    "description": "OpenAPI specification for Supabase Edge Functions that power PPS AI proxying and observability beacons. Generated via swagger-jsdoc.",
    "contact": {
      "name": "Pavement Performance Suite Engineering",
      "url": "https://github.com/continue-repo"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "externalDocs": {
    "description": "Project documentation",
    "url": "https://github.com/continue-repo/pavement-performance-suite/tree/main/docs"
  },
  "servers": [
    {
      "url": "https://{projectRef}.functions.supabase.co",
      "description": "Supabase hosted Edge Functions",
      "variables": {
        "projectRef": {
          "default": "your-project-ref",
          "description": "Supabase project reference ID (e.g. vodglzbgqsafghlihivy)"
        }
      }
    },
    {
      "url": "http://localhost:54321/functions/v1",
      "description": "Local Supabase CLI"
    }
  ],
  "tags": [
    {
      "name": "AI",
      "description": "Generative AI proxy endpoints"
    },
    {
      "name": "Observability",
      "description": "Telemetry capture and log beacons"
    },
    {
      "name": "Intelligence",
      "description": "Supplier pricing and operations insights"
    }
  ],
  "paths": {
    "/gemini-proxy": {
      "post": {
        "tags": [
          "AI"
        ],
        "summary": "Proxy Gemini API calls",
        "description": "Routes chat, image, and embedding requests to Google Gemini models while keeping API keys on the server. Requires a Supabase JWT (anon or service) supplied as `Authorization: Bearer <token>`.",
        "operationId": "GeminiProxy",
        "security": [
          {
            "supabaseAnonKey": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GeminiProxyRequest"
              },
              "examples": {
                "chat": {
                  "summary": "Chat prompt",
                  "value": {
                    "action": "chat",
                    "contents": [
                      {
                        "parts": [
                          {
                            "text": "Summarize sealcoating steps for a 25,000 sq ft church campus."
                          }
                        ]
                      }
                    ]
                  }
                },
                "embed": {
                  "summary": "Embedding request",
                  "value": {
                    "action": "embed",
                    "text": "Church lot resurfacing quote"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Gemini response payload",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GeminiProxyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Unsupported action or malformed body",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing Authorization header"
          },
          "405": {
            "description": "Method not allowed"
          },
          "500": {
            "description": "Upstream error or missing API key"
          }
        }
      }
    },
    "/log-beacon": {
      "post": {
        "tags": [
          "Observability"
        ],
        "summary": "Ingest client log beacons",
        "description": "Receives structured telemetry events from the Pavement Performance Suite web client for centralized logging and incident roll-up. Supports single objects or batches up to 50 entries.",
        "operationId": "LogBeacon",
        "security": [
          {
            "supabaseAnonKey": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LogBeaconPayload"
              },
              "examples": {
                "single": {
                  "summary": "Single telemetry event",
                  "value": {
                    "event": "lovable.asset_load_error",
                    "level": "error",
                    "assetUrl": "https://preview.example.com/static/logo.png",
                    "pageUrl": "https://preview.example.com/dashboard",
                    "reason": "Failed to load resource"
                  }
                },
                "batch": {
                  "summary": "Batch payload",
                  "value": [
                    {
                      "event": "mission.scheduler_loaded",
                      "level": "info"
                    },
                    {
                      "event": "lovable.asset_recovered",
                      "level": "warn",
                      "message": "Recovered after retry"
                    }
                  ]
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Beacon accepted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LogBeaconResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid JSON payload or validation failure",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Missing or invalid Supabase JWT"
          },
          "405": {
            "description": "Method not allowed"
          },
          "500": {
            "description": "Persistence failure while writing telemetry rows"
          }
        }
      }
    }
  ],
  "components": {
    "securitySchemes": {
      "supabaseAnonKey": {
        "type": "apiKey",
        "in": "header",
        "name": "apikey",
        "description": "Supabase anon or service key. When calling from browsers use the anon public key; for server-to-server use service role credentials via the 'apikey' header."
      },
      "supabaseBearer": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase JWT (anon or service role). Provide as `Authorization: Bearer <token>` when invoking Edge Functions."
      }
    },
    "schemas": {
      "GeminiProxyRequest": {
        "type": "object",
        "description": "Payload forwarded to Google Gemini.",
        "properties": {
          "action": {
            "type": "string",
            "enum": [
              "chat",
              "image",
              "embed"
            ],
            "description": "Operation to perform."
          },
          "contents": {
            "type": "array",
            "description": "Gemini content payload, required for chat and image actions.",
            "items": {
              "type": "object",
              "additionalProperties": true
            }
          },
          "text": {
            "type": "string",
            "description": "Plain text to embed when action === 'embed'.",
            "minLength": 1,
            "maxLength": 5000
          }
        },
        "required": [
          "action"
        ],
        "additionalProperties": false
      },
      "GeminiProxyResponse": {
        "type": "object",
        "description": "Subset of the Gemini response returned to clients.",
        "properties": {
          "text": {
            "type": "string",
            "description": "Generated text for chat/image requests."
          },
          "embedding": {
            "type": "object",
            "properties": {
              "values": {
                "type": "array",
                "items": {
                  "type": "number"
                }
              }
            }
          }
        },
        "additionalProperties": true
      },
      "LogEvent": {
        "type": "object",
        "description": "Telemetry event emitted by the Pavement Performance Suite client.",
        "properties": {
          "event": {
            "type": "string",
            "description": "Event name (e.g. lovable.asset_load_error)."
          },
          "level": {
            "type": "string",
            "enum": [
              "debug",
              "info",
              "warn",
              "error"
            ],
            "default": "info"
          },
          "message": {
            "type": "string",
            "description": "Human readable message."
          },
          "reason": {
            "type": "string",
            "description": "Optional rejection reason or exception."
          },
          "timestamp": {
            "type": "string",
            "description": "Client-provided timestamp (ISO-8601 or epoch milliseconds)."
          },
          "sessionId": {
            "type": "string",
            "description": "Client session identifier."
          },
          "deviceId": {
            "type": "string",
            "description": "Client device identifier."
          },
          "environment": {
            "type": "string",
            "description": "Environment label (production, staging, loadtest)."
          },
          "pageUrl": {
            "type": "string",
            "format": "uri",
            "description": "Page URL where the event occurred."
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "Deprecated alias for pageUrl (supported for backward compatibility)."
          },
          "assetUrl": {
            "type": "string",
            "format": "uri",
            "description": "Asset URL tied to lovable.asset_* events."
          },
          "assetTag": {
            "type": "string",
            "description": "DOM tag name for the asset (img, script, link, etc.)."
          },
          "userAgent": {
            "type": "string",
            "description": "User agent string captured server-side when provided."
          },
          "metadata": {
            "type": "object",
            "description": "Arbitrary metadata supplied by the client.",
            "additionalProperties": true
          }
        },
        "required": [
          "event"
        ],
        "additionalProperties": true
      },
      "LogBeaconPayload": {
        "description": "Single telemetry event or batch of events.",
        "anyOf": [
          {
            "$ref": "#/components/schemas/LogEvent"
          },
          {
            "type": "array",
            "minItems": 1,
            "maxItems": 50,
            "description": "Batch submission of telemetry events (max 50 per request).",
            "items": {
              "$ref": "#/components/schemas/LogEvent"
            }
          }
        ]
      },
      "SupplierIntelRequest": {
        "type": "object",
        "description": "Optional filters supplied when requesting supplier intelligence.",
        "properties": {
          "orgId": {
            "type": "string",
            "format": "uuid",
            "description": "Organization identifier. Defaults to the caller’s organisation if omitted."
          },
          "materials": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "maxItems": 12,
            "description": "Material identifiers to include (defaults to organisation-wide recent materials)."
          },
          "radiusMiles": {
            "type": "number",
            "minimum": 0,
            "maximum": 500,
            "description": "Optional supplier coverage radius filter."
          },
          "includeAiSummary": {
            "type": "boolean",
            "description": "Set to false to skip the Gemini summarisation step.",
            "default": true
          },
          "jobLocation": {
            "type": "object",
            "description": "Optional job geolocation used for future geospatial ranking.",
            "properties": {
              "lat": {
                "type": "number",
                "minimum": -90,
                "maximum": 90
              },
              "lng": {
                "type": "number",
                "minimum": -180,
                "maximum": 180
              }
            }
          }
        }
      },
      "SupplierPriceHistoryPoint": {
        "type": "object",
        "properties": {
          "effectiveDate": {
            "type": "string",
            "format": "date-time"
          },
          "unitPrice": {
            "type": "number"
          },
          "currency": {
            "type": "string"
          }
        },
        "required": [
          "effectiveDate",
          "unitPrice",
          "currency"
        ]
      },
      "SupplierInsight": {
        "type": "object",
        "description": "Per-supplier price snapshot enriched with context.",
        "properties": {
          "supplierId": {
            "type": "string"
          },
          "supplierName": {
            "type": "string"
          },
          "materialType": {
            "type": "string"
          },
          "materialGrade": {
            "type": [
              "string",
              "null"
            ]
          },
          "unitPrice": {
            "type": "number"
          },
          "unitOfMeasure": {
            "type": "string"
          },
          "currency": {
            "type": "string"
          },
          "effectiveDate": {
            "type": "string",
            "format": "date-time"
          },
          "confidence": {
            "type": [
              "number",
              "null"
            ]
          },
          "source": {
            "type": [
              "string",
              "null"
            ]
          },
          "trailing30DayAverage": {
            "type": [
              "number",
              "null"
            ]
          },
          "sevenDayChangePercent": {
            "type": [
              "number",
              "null"
            ]
          },
          "sampleCount": {
            "type": "integer"
          },
          "leadTimeDays": {
            "type": [
              "number",
              "null"
            ]
          },
          "coverageRadiusMiles": {
            "type": [
              "number",
              "null"
            ]
          },
          "reliabilityScore": {
            "type": [
              "number",
              "null"
            ]
          },
          "contact": {
            "type": [
              "object",
              "null"
            ],
            "additionalProperties": true
          },
          "metadata": {
            "type": [
              "object",
              "null"
            ],
            "additionalProperties": true
          },
          "priceHistory": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SupplierPriceHistoryPoint"
            }
          }
        },
        "required": [
          "supplierId",
          "supplierName",
          "materialType",
          "unitPrice",
          "unitOfMeasure",
          "currency",
          "effectiveDate",
          "sampleCount",
          "priceHistory"
        ]
      },
      "SupplierBestOffer": {
        "type": "object",
        "description": "Best offer for a material across all suppliers.",
        "properties": {
          "supplierId": {
            "type": "string"
          },
          "supplierName": {
            "type": "string"
          },
          "unitPrice": {
            "type": "number"
          },
          "currency": {
            "type": "string"
          },
          "leadTimeDays": {
            "type": [
              "number",
              "null"
            ]
          }
        },
        "required": [
          "supplierId",
          "supplierName",
          "unitPrice",
          "currency"
        ]
      },
      "SupplierIntelResponse": {
        "type": "object",
        "properties": {
          "orgId": {
            "type": "string",
            "format": "uuid"
          },
          "materials": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "generatedAt": {
            "type": "string",
            "format": "date-time"
          },
          "insights": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/SupplierInsight"
            }
          },
          "bestOffers": {
            "type": "object",
            "description": "Dictionary keyed by material identifier with the best offer.",
            "additionalProperties": {
              "$ref": "#/components/schemas/SupplierBestOffer"
            }
          },
          "aiSummary": {
            "type": [
              "string",
              "null"
            ],
            "description": "Optional Gemini-generated summary."
          }
        },
        "required": [
          "orgId",
          "materials",
          "generatedAt",
          "insights",
          "bestOffers",
          "aiSummary"
        ]
      }
    }
  },
  "paths": {
    "/gemini-proxy": {
      "post": {
        "tags": [
          "AI"
        ],
        "summary": "Proxy Gemini API requests",
        "description": "Routes chat, image, and embedding requests to Google Gemini models while keeping API keys server-side.\nRequires a Supabase JWT (anon key or service role) present in the `Authorization` header.\n",
        "operationId": "postGeminiProxy",
        "security": [
          {
            "supabaseBearer": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GeminiProxyRequest"
              },
              "examples": {
                "chat": {
                  "summary": "Chat prompt",
                  "value": {
                    "action": "chat",
                    "contents": [
                      {
                        "parts": [
                          {
                            "text": "Summarize sealcoating steps for a church parking lot"
                          }
                        ]
                      }
                    ]
                  }
                },
                "embed": {
                  "summary": "Generate text embeddings",
                  "value": {
                    "action": "embed",
                    "text": "Crack sealing crew checklist"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Gemini response payload",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GeminiProxyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation failed or unsupported action"
          },
          "401": {
            "description": "Missing or invalid Supabase JWT"
          },
          "405": {
            "description": "Method not allowed"
          },
          "500": {
            "description": "Upstream Gemini error or missing API key"
          }
        }
      }
    },
    "/log-beacon": {
      "post": {
        "tags": [
          "Observability"
        ],
        "summary": "Ingest client log beacons",
        "description": "Receives structured telemetry events from the Pavement Performance Suite web client.\nAccepts either a single event object or an array of up to 50 events and persists them into\nobservability tables for later analytics and incident response.\n",
        "operationId": "postLogBeacon",
        "security": [
          {
            "supabaseBearer": []
          },
          {
            "supabaseAnonKey": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LogBeaconPayload"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Beacon accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ingested": {
                      "type": "integer",
                      "description": "Number of events successfully persisted."
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid JSON payload or validation failure"
          },
          "401": {
            "description": "Missing or invalid Supabase JWT"
          },
          "405": {
            "description": "Method not allowed"
          },
          "500": {
            "description": "Supabase persistence failure or service misconfiguration"
          }
        }
      }
    },
    "/supplier-intel": {
      "post": {
        "tags": [
          "Intelligence"
        ],
        "summary": "Generate supplier pricing intelligence",
        "description": "Aggregates recent supplier pricing snapshots, computes best offers per material,\nand optionally produces a Gemini-authored summary to guide estimators and schedulers.\nRequires a Supabase JWT in the `Authorization` header; the service resolves the caller's\norganization automatically when `orgId` is not supplied.\n",
        "operationId": "postSupplierIntel",
        "security": [
          {
            "supabaseBearer": []
          }
        ],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SupplierIntelRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Supplier intelligence generated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SupplierIntelResponse"
                }
              }
            }
          },
          "400": {
            "description": "Missing org context or invalid radius/material filter"
          },
          "401": {
            "description": "Missing or invalid Supabase JWT"
          },
          "422": {
            "description": "Request validation failed"
          },
          "500": {
            "description": "Unexpected error while computing insights or contacting Gemini"
          }
        }
      "LogBeaconResponse": {
        "type": "object",
        "properties": {
          "ingested": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of events successfully persisted."
          }
        },
        "required": [
          "ingested"
        ],
        "additionalProperties": false
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Human-readable error message."
          },
          "details": {
            "description": "Optional validation or diagnostic details.",
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              {
                "type": "object",
                "additionalProperties": true
              }
            ]
          }
        },
        "required": [
          "error"
        ],
        "additionalProperties": true
      }
    }
  }
}